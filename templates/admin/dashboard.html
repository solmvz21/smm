{% extends "admin/base_site.html" %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  .card { 
    border-radius: 15px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    transition: transform 0.3s, box-shadow 0.3s, box-shadow 0.6s; 
    overflow: hidden;
    position: relative;
  }
  .card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 6px 25px rgba(0,0,0,0.3);
    animation: glow 1.5s infinite alternate;
  }
  @keyframes glow {
    0% { box-shadow: 0 6px 25px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2); }
    100% { box-shadow: 0 6px 25px rgba(0,0,0,0.3), 0 0 25px rgba(255,255,255,0.4); }
  }
  .chart-container { position: relative; height: 350px; }
  .counter { font-weight: 700; font-size: 2rem; }
  .filter-form input { max-width: 180px; margin-right: 10px; }
  .card-icon { font-size: 2.5rem; margin-bottom: 10px; color: #fff; }
  .card-visitors { background: linear-gradient(135deg, #36D1DC, #5B86E5); color: #fff; }
  .card-subscribers { background: linear-gradient(135deg, #FF9A9E, #FAD0C4); color: #fff; }
  .card-sales { background: linear-gradient(135deg, #FDC830, #F37335); color: #fff; }
  .card-profits { background: linear-gradient(135deg, #43e97b, #38f9d7); color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Tarih Aralığı Filtreleme -->
  <form method="get" class="mb-4 filter-form d-flex flex-wrap align-items-end">
    <div>
      <label for="start_date">Başlangıç:</label>
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>
    <div>
      <label for="end_date">Bitiş:</label>
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary ms-2">Filtrele</button>
  </form>

  <!-- İstatistik Kartları -->
  <div class="row g-3">
    <div class="col-md-3 col-sm-6">
      <div class="card text-center p-3 card-visitors">
        <div class="card-icon"><i class="fas fa-users"></i></div>
        <h5>Ziyaretçiler</h5>
        <div class="counter" data-target="{{ visitors }}">0</div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-center p-3 card-subscribers">
        <div class="card-icon"><i class="fas fa-shopping-bag"></i></div>
        <h5>Ürünler</h5>
        <div class="counter" data-target="{{ subscribers }}">0</div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-center p-3 card-sales">
        <div class="card-icon"><i class="fas fa-dollar-sign"></i></div>
        <h5>Satış</h5>
        <div class="counter" data-target="{{ sales }}">0</div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card text-center p-3 card-profits">
        <div class="card-icon"><i class="fas fa-coins"></i></div>
        <h5>Kâr</h5>
        <div class="counter" data-target="{{ profits }}">0</div>
      </div>
    </div>
  </div>

  <!-- Grafikler -->
  <div class="row mt-4 g-3">
    <div class="col-lg-8 col-md-12">
      <div class="card p-3">
        <h5>Son 7 Gün Satış Grafiği</h5>
        <div class="chart-container">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-12">
      <div class="card p-3">
        <h5>Ziyaretçi Dağılımı</h5>
        <div class="chart-container">
          <canvas id="visitorChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Kart animasyonu
  const counters = document.querySelectorAll('.counter');
  counters.forEach(counter => {
    const updateCount = () => {
      const target = +counter.getAttribute('data-target');
      const current = +counter.innerText.replace(/[^0-9.-]+/g,"");
      const increment = target / 100;
      if (current < target) {
        counter.innerText = Math.ceil(current + increment);
        setTimeout(updateCount, 15);
      } else {
        counter.innerText = target;
      }
    };
    updateCount();
  });

  // Veriler
  const salesLabels = {{ sales_chart_labels|safe }};
  const salesData = {{ sales_chart_data|safe }};
  const visitorLabels = {{ user_distribution_labels|safe }};
  const visitorData = {{ user_distribution_data|safe }};

  // Dinamik gradient
  const getGradient = ctx => {
    const gradient = ctx.createLinearGradient(0,0,0,350);
    gradient.addColorStop(0, 'rgba(75,192,192,0.6)');
    gradient.addColorStop(1, 'rgba(75,192,192,0.05)');
    return gradient;
  };

  // Satış Grafiği
  const salesCtx = document.getElementById('salesChart').getContext('2d');
  new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: salesLabels,
      datasets: [{
        label: 'Satışlar',
        data: salesData,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: getGradient(salesCtx),
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 12
      }]
    },
    options: { responsive: true }
  });

  // Ziyaretçi Grafiği
  const visitorCtx = document.getElementById('visitorChart').getContext('2d');
  new Chart(visitorCtx, {
    type: 'doughnut',
    data: {
      labels: visitorLabels,
      datasets: [{
        data: visitorData,
        backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'],
        hoverOffset: 30
      }]
    },
    options: { responsive: true }
  });
</script>
{% endblock %}
